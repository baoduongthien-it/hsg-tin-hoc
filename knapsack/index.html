<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Công cụ trực quan hóa thuật toán Knapsack (Cái túi) chuyên nghiệp. Học Dynamic Programming qua hình ảnh sống động."
    />
    <base href="/hsg-tin-hoc/" />
    <title>Học thuật toán Knapsack - Trực quan & Chuyên nghiệp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Outfit", "sans-serif"],
              mono: ["Fira Code", "monospace"],
            },
            colors: {
              brand: {
                50: "#f5f3ff",
                100: "#ede9fe",
                200: "#ddd6fe",
                300: "#c4b5fd",
                400: "#a78bfa",
                500: "#8b5cf6",
                600: "#7c3aed",
                700: "#6d28d9",
                800: "#5b21b6",
                900: "#4c1d95",
                950: "#2e1065",
              },
            },
            animation: {
              "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              float: "float 3s ease-in-out infinite",
            },
            keyframes: {
              float: {
                "0%, 100%": { transform: "translateY(0)" },
                "50%": { transform: "translateY(-10px)" },
              },
            },
          },
        },
      };
    </script>

    <style type="text/tailwindcss">
      @layer components {
        .glass-card {
          @apply bg-white/80 backdrop-blur-xl border border-white/20 shadow-xl;
        }
        .btn-primary {
          @apply bg-brand-600 hover:bg-brand-700 text-white px-6 py-2.5 rounded-2xl font-semibold transition-all duration-300 shadow-lg shadow-brand-900/20 hover:shadow-brand-900/30 active:scale-95 disabled:opacity-50 disabled:pointer-events-none;
        }
        .btn-secondary {
          @apply bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-xl font-medium transition-all duration-300 active:scale-95 disabled:opacity-50;
        }
        .code-line {
          @apply px-4 py-1 border-l-2 border-transparent transition-all duration-200;
        }
        .code-line.active {
          @apply bg-brand-500/10 border-brand-500 text-brand-700 font-medium;
        }
        .dp-cell {
          @apply w-12 h-14 md:w-16 md:h-20 flex flex-col items-center justify-center rounded-2xl border-2 transition-all duration-500 relative;
        }
      }

      .scroll-custom::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .scroll-custom::-webkit-scrollbar-track {
        background: transparent;
      }
      .scroll-custom::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }
      .scroll-custom::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      .cell-target {
        background: linear-gradient(135deg, #22c55e, #10b981) !important;
        color: white;
        border-color: #059669 !important;
        transform: translateY(-8px) scale(1.1);
        box-shadow: 0 15px 30px -10px rgba(16, 185, 129, 0.25);
        z-index: 20;
      }
      .cell-source {
        background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
        color: white;
        border-color: #1d4ed8 !important;
        transform: scale(1.05);
        box-shadow: 0 10px 20px -10px rgba(59, 130, 246, 0.2);
      }
      .item-active {
        @apply ring-4 ring-brand-500/30 border-brand-500 bg-brand-50 scale-[1.02] -translate-y-1 shadow-2xl z-10;
      }

      body {
        background-image: radial-gradient(
            at 0% 0%,
            hsla(253, 16%, 7%, 1) 0,
            transparent 50%
          ),
          radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
          radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
        background-attachment: fixed;
      }
    </style>
  </head>
  <body
    class="bg-slate-950 min-h-screen text-slate-100 selection:bg-brand-500/30"
  >
    <!-- Overlay for background softness -->
    <div class="fixed inset-0 bg-slate-50/10 backdrop-blur-3xl -z-10"></div>

    <header class="sticky top-0 z-50 px-4 py-3 md:px-8 md:py-4">
      <nav
        class="max-w-[1600px] mx-auto glass-card rounded-3xl flex items-center justify-between px-6 py-2 border-white/10 bg-white/5"
      >
        <div class="flex items-center gap-4">
          <div
            class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-br from-brand-500 to-violet-600 rounded-2xl flex items-center justify-center text-white shadow-md shadow-brand-500/10 animate-float"
          >
            <i class="fas fa-briefcase text-lg md:text-xl"></i>
          </div>
          <div>
            <h1
              class="text-lg md:text-xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400"
            >
              Knapsack Visualizer
            </h1>
            <p
              class="text-[10px] md:text-xs text-slate-500 font-medium uppercase tracking-widest hidden md:block"
            >
              Interactive Algorithm Tool
            </p>
          </div>
        </div>

        <div class="hidden lg:flex items-center gap-4">
          <div
            class="flex items-center gap-1 bg-slate-900/50 p-1.5 rounded-2xl border border-white/5"
          >
            <button
              id="btnPrev"
              onclick="prevStep()"
              class="p-2.5 hover:bg-white/10 rounded-xl transition-all disabled:opacity-20"
            >
              <i class="fas fa-arrow-left"></i>
            </button>
            <button
              id="btnPlay"
              onclick="toggleAuto()"
              class="btn-primary flex items-center gap-2 min-w-[140px] justify-center group"
            >
              <i class="fas fa-play group-[.paused]:hidden"></i>
              <span class="group-[.paused]:hidden">Chạy tự động</span>
              <i class="fas fa-pause hidden group-[.paused]:block"></i>
              <span class="hidden group-[.paused]:block">Tạm dừng</span>
            </button>
            <button
              id="btnNext"
              onclick="nextStep()"
              class="p-2.5 hover:bg-white/10 rounded-xl transition-all disabled:opacity-20"
            >
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
          <button
            onclick="resetSim()"
            class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all"
            title="Làm mới"
          >
            <i class="fas fa-rotate"></i>
          </button>
        </div>

        <!-- Mobile Controls Toggle -->
        <div class="lg:hidden flex items-center gap-2">
          <button onclick="resetSim()" class="p-2 text-slate-400">
            <i class="fas fa-rotate"></i>
          </button>
          <button
            id="mobileNext"
            onclick="nextStep()"
            class="p-3 bg-brand-600 rounded-xl text-white"
          >
            <i class="fas fa-step-forward"></i>
          </button>
        </div>
      </nav>
    </header>

    <main class="p-4 md:p-6 max-w-[1600px] mx-auto">
      <div class="grid grid-cols-12 gap-6">
        <!-- Sidebar Config -->
        <aside class="col-span-12 lg:col-span-3 space-y-6">
          <section
            class="glass-card rounded-[2rem] p-6 bg-white/5 border-white/5"
          >
            <div class="flex items-center gap-3 mb-6">
              <span class="w-2 h-6 bg-brand-500 rounded-full"></span>
              <h2
                class="text-sm font-bold text-slate-400 uppercase tracking-widest"
              >
                Cấu hình
              </h2>
            </div>

            <div class="space-y-5">
              <div class="space-y-2">
                <label class="text-xs font-semibold text-slate-500 px-1"
                  >Thuật toán</label
                >
                <div class="relative group">
                  <select
                    id="algoType"
                    onchange="resetSim()"
                    class="w-full bg-slate-900/50 border border-white/10 p-3.5 rounded-2xl text-sm focus:ring-2 focus:ring-brand-500 outline-none appearance-none transition-all cursor-pointer"
                  >
                    <option value="01">0/1 Knapsack (Lấy 1 lần)</option>
                    <option value="unbounded">Unbounded (Lấy vô hạn)</option>
                  </select>
                  <i
                    class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none transition-transform group-focus-within:rotate-180"
                  ></i>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                  <label class="text-xs font-semibold text-slate-500 px-1"
                    >Vật phẩm (N)</label
                  >
                  <input
                    type="number"
                    id="inputN"
                    value="3"
                    min="1"
                    max="10"
                    class="w-full bg-slate-900/50 border border-white/10 p-3.5 rounded-2xl text-sm transition-all focus:ring-2 focus:ring-brand-500 outline-none"
                    onchange="updateItemsUI()"
                  />
                </div>
                <div class="space-y-2">
                  <label class="text-xs font-semibold text-slate-500 px-1"
                    >Sức chứa (M)</label
                  >
                  <input
                    type="number"
                    id="inputM"
                    value="7"
                    min="1"
                    max="20"
                    class="w-full bg-slate-900/50 border border-white/10 p-3.5 rounded-2xl text-sm transition-all focus:ring-2 focus:ring-brand-500 outline-none"
                    onchange="resetSim()"
                  />
                </div>
              </div>
            </div>
          </section>

          <section
            class="glass-card rounded-[2rem] p-6 bg-white/5 border-white/5 flex flex-col max-h-[600px]"
          >
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center gap-3">
                <span class="w-2 h-6 bg-pink-500 rounded-full"></span>
                <h2
                  class="text-sm font-bold text-slate-400 uppercase tracking-widest"
                >
                  Dữ liệu
                </h2>
              </div>
              <span
                class="text-[10px] bg-slate-800 text-slate-400 px-2.5 py-1 rounded-full border border-white/5"
                id="itemCount"
                >3 Items</span
              >
            </div>

            <div
              id="itemsContainer"
              class="space-y-4 overflow-y-auto scroll-custom pr-2 -mr-2"
            >
              <!-- Items will be injected here -->
            </div>

            <button
              onclick="resetSim()"
              class="w-full mt-6 btn-primary !rounded-2xl flex items-center justify-center gap-2"
            >
              <i class="fas fa-bolt"></i> Cập nhật ngay
            </button>
          </section>
        </aside>

        <!-- Center Visualization -->
        <div class="col-span-12 lg:col-span-6 space-y-6">
          <section
            class="glass-card rounded-[2rem] p-6 md:p-8 bg-white/5 border-white/10 min-h-[400px] flex flex-col"
          >
            <div
              class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8"
            >
              <div>
                <h2 class="text-xl font-bold text-white">
                  Bảng Quy hoạch động
                </h2>
                <p class="text-sm text-slate-400 mt-1">
                  Trạng thái mảng DP qua từng bước
                </p>
              </div>
              <div class="flex flex-wrap gap-4 text-[10px] md:text-xs">
                <div
                  class="flex items-center gap-2 px-3 py-1.5 bg-blue-500/10 border border-blue-500/20 rounded-full text-blue-400 font-medium"
                >
                  <span
                    class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.6)]"
                  ></span>
                  Nguồn (dp[j-w])
                </div>
                <div
                  class="flex items-center gap-2 px-3 py-1.5 bg-green-500/10 border border-green-500/20 rounded-full text-green-400 font-medium"
                >
                  <span
                    class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"
                  ></span>
                  Đang tính (dp[j])
                </div>
              </div>
            </div>

            <div
              class="flex-1 flex items-center justify-center overflow-x-auto scroll-custom py-8"
            >
              <div
                id="dpGrid"
                class="flex flex-wrap gap-4 md:gap-6 justify-center max-w-full px-4"
              >
                <!-- Cells injected here -->
              </div>
            </div>
          </section>

          <!-- Status & Explanation -->
          <section
            id="statusCard"
            class="relative group overflow-hidden rounded-[2rem] p-8 transition-all duration-500 bg-gradient-to-br from-brand-900/80 to-slate-950 border border-brand-500/20 shadow-2xl shadow-brand-500/5"
          >
            <div
              class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10 mix-blend-overlay"
            ></div>
            <div
              class="absolute -right-16 -bottom-16 w-64 h-64 bg-brand-500/10 rounded-full blur-[100px] group-hover:bg-brand-500/20 transition-all duration-700"
            ></div>

            <div
              class="relative z-10 flex flex-col md:flex-row gap-6 items-start"
            >
              <div
                class="w-12 h-12 rounded-2xl bg-brand-500/20 flex items-center justify-center text-brand-400 border border-brand-500/30 flex-shrink-0"
              >
                <i class="fas fa-lightbulb text-xl animate-pulse"></i>
              </div>
              <div class="space-y-3">
                <p
                  class="text-xs font-bold text-brand-400 uppercase tracking-widest"
                >
                  Phân tích bước hiện tại
                </p>
                <p
                  id="explanation"
                  class="text-base md:text-xl font-medium leading-relaxed text-slate-100 italic"
                >
                  Sẵn sàng để bắt đầu? Nhấn "Tiếp theo" để khám phá cách thuật
                  toán vận hành.
                </p>
              </div>
            </div>
          </section>
        </div>

        <!-- Right Side: Code & Meta -->
        <div class="col-span-12 lg:col-span-3 space-y-6">
          <section
            class="glass-card rounded-[2rem] bg-[#0f172a] border-white/5 overflow-hidden flex flex-col h-full ring-1 ring-white/5 shadow-2xl"
          >
            <div
              class="bg-slate-900/80 px-5 py-4 border-b border-white/5 flex items-center justify-between"
            >
              <div class="flex items-center gap-3">
                <div class="flex gap-1.5">
                  <span class="w-2.5 h-2.5 rounded-full bg-rose-500"></span>
                  <span class="w-2.5 h-2.5 rounded-full bg-amber-500"></span>
                  <span class="w-2.5 h-2.5 rounded-full bg-emerald-500"></span>
                </div>
                <span
                  class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-2"
                  >cpp_logic.cpp</span
                >
              </div>
              <span class="text-[9px] font-mono text-slate-500">v1.2.0</span>
            </div>

            <div
              class="p-6 font-mono text-[13px] leading-7 flex-1 text-slate-400 overflow-hidden relative"
            >
              <div id="L1" class="code-line">
                for (int i = 1; i <= N; i++) {
              </div>
              <div id="L2" class="code-line pl-6">
                for (int j =
                <span id="loopCode" class="text-amber-400">...</span>) {
              </div>
              <div id="L3" class="code-line pl-12 text-slate-300">
                ll <span class="text-blue-400">gia_tri_moi</span> = dp[j-w[i]] +
                v[i];
              </div>
              <div id="L4" class="code-line pl-12">
                if (<span class="text-blue-400">gia_tri_moi</span> > dp[j]) {
              </div>
              <div
                id="L5"
                class="code-line pl-[4.5rem] !text-emerald-400 font-semibold bg-emerald-500/5 rounded-lg"
              >
                dp[j] = gia_tri_moi;
              </div>
              <div id="L6" class="code-line pl-12">}</div>
              <div id="L7" class="code-line pl-6">}</div>
              <div id="L8" class="code-line">}</div>

              <div
                class="absolute bottom-4 left-6 right-6 p-4 rounded-2xl bg-slate-900/50 border border-white/5 mt-8"
              >
                <div class="flex justify-between items-center mb-3">
                  <span
                    class="text-[10px] font-bold text-slate-500 uppercase tracking-widest"
                    >Tốc độ mô phỏng</span
                  >
                  <span
                    id="speedVal"
                    class="text-[10px] font-bold text-brand-400"
                    >1.0s</span
                  >
                </div>
                <input
                  type="range"
                  id="speed"
                  min="200"
                  max="1800"
                  value="1000"
                  class="w-full h-1.5 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-brand-500 transition-all hover:accent-brand-400"
                  oninput="document.getElementById('speedVal').innerText = ((2000 - this.value)/1000).toFixed(1) + 's'"
                />
              </div>
            </div>
          </section>

          <!-- Instructions Card -->
          <section
            class="glass-card rounded-[2rem] p-6 bg-brand-500/5 border-brand-500/10"
          >
            <h3
              class="text-xs font-bold text-brand-400 uppercase tracking-widest mb-4 flex items-center gap-2"
            >
              <i class="fas fa-info-circle"></i> Mẹo nhỏ
            </h3>
            <ul class="text-xs text-slate-400 space-y-3 leading-relaxed">
              <li class="flex gap-2">
                <span class="text-brand-500">•</span>
                <span
                  >Thay đổi <b>N</b> hoặc <b>M</b> để xem bảng DP mở rộng linh
                  hoạt.</span
                >
              </li>
              <li class="flex gap-2">
                <span class="text-brand-500">•</span>
                <span
                  >Chế độ <b>Unbounded</b> mô phỏng khi bạn có vô hạn số lượng
                  mỗi vật phẩm.</span
                >
              </li>
            </ul>
          </section>
        </div>
      </div>
    </main>

    <!-- Mobile Controls Float (optional, but keep it desktop-first for now) -->
    <div
      class="lg:hidden fixed bottom-6 left-1/2 -translate-x-1/2 flex items-center gap-2 p-2 bg-slate-900 border border-white/10 rounded-2xl shadow-2xl glass-card"
    >
      <button onclick="prevStep()" class="p-3 text-slate-400">
        <i class="fas fa-arrow-left"></i>
      </button>
      <button
        id="mobilePlay"
        onclick="toggleAuto()"
        class="px-6 py-3 bg-brand-600 rounded-xl text-white font-bold flex items-center gap-2"
      >
        <i class="fas fa-play"></i>
      </button>
      <button onclick="nextStep()" class="p-3 text-slate-400">
        <i class="fas fa-arrow-right"></i>
      </button>
    </div>

    <script>
      let items = [];
      let steps = [];
      let currentStep = -1;
      let isAuto = false;
      let timer = null;

      function updateItemsUI() {
        const n = Math.min(
          parseInt(document.getElementById("inputN").value) || 1,
          10
        );
        document.getElementById("inputN").value = n;
        document.getElementById("itemCount").innerText = `${n} Item${
          n > 1 ? "s" : ""
        }`;

        const container = document.getElementById("itemsContainer");
        container.innerHTML = "";
        for (let i = 0; i < n; i++) {
          const w = 2 + i;
          const v = 3 + i * 2;
          container.innerHTML += `
            <div id="item-card-${i}" class="bg-slate-900/40 p-5 rounded-2xl border border-white/5 transition-all duration-500 group relative hover:border-brand-500/30">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                      <span class="flex items-center justify-center w-6 h-6 bg-brand-500/10 text-brand-400 rounded-lg text-[10px] font-bold border border-brand-500/20">${
                        i + 1
                      }</span>
                      <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Vật phẩm</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-slate-600 uppercase ml-1">Cân nặng</label>
                        <div class="relative">
                            <i class="fas fa-weight-hanging absolute left-3 top-1/2 -translate-y-1/2 text-slate-600 text-[10px]"></i>
                            <input type="number" id="w-${i}" value="${w}" class="w-full bg-slate-950/50 pl-8 pr-3 py-2.5 border border-white/5 rounded-xl text-sm font-bold focus:ring-1 focus:ring-brand-500 outline-none transition-all">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-slate-600 uppercase ml-1">Giá trị</label>
                        <div class="relative">
                            <i class="fas fa-dollar-sign absolute left-3 top-1/2 -translate-y-1/2 text-slate-600 text-[10px]"></i>
                            <input type="number" id="v-${i}" value="${v}" class="w-full bg-slate-950/50 pl-8 pr-3 py-2.5 border border-white/5 rounded-xl text-sm font-bold focus:ring-1 focus:ring-brand-500 outline-none transition-all">
                        </div>
                    </div>
                </div>
            </div>`;
        }
        resetSim();
      }

      function generateSteps() {
        const type = document.getElementById("algoType").value;
        const n = parseInt(document.getElementById("inputN").value);
        const m = parseInt(document.getElementById("inputM").value);
        items = [];
        for (let i = 0; i < n; i++) {
          items.push({
            w: parseInt(document.getElementById(`w-${i}`).value) || 0,
            v: parseInt(document.getElementById(`v-${i}`).value) || 0,
          });
        }

        let dp = Array(m + 1).fill(0);
        steps = [
          {
            dp: [...dp],
            i: -1,
            j: -1,
            L: 0,
            msg: "Khởi tạo mảng Quy hoạch động (DP) với tất cả giá trị ban đầu là 0.",
          },
        ];

        for (let i = 0; i < items.length; i++) {
          const { w, v } = items[i];
          steps.push({
            dp: [...dp],
            i,
            j: -1,
            L: 1,
            msg: `Đang xét Vật phẩm số ${
              i + 1
            } có Cân nặng = ${w} và Giá trị = ${v}.`,
          });

          let range = [];
          if (type === "01") {
            for (let j = m; j >= w; j--) range.push(j);
          } else {
            for (let j = w; j <= m; j++) range.push(j);
          }

          for (let j of range) {
            steps.push({
              dp: [...dp],
              i,
              j,
              L: 2,
              msg: `Tính toán cho túi có sức chứa hiện tại j = ${j}.`,
            });
            let prevVal = dp[j - w];
            let gia_tri_moi = prevVal + v;
            steps.push({
              dp: [...dp],
              i,
              j,
              L: 3,
              msg: `Nếu chọn vật phẩm ${i + 1}: Giá trị mới = dp[${
                j - w
              }] + ${v} = ${prevVal} + ${v} = ${gia_tri_moi}.`,
            });

            if (gia_tri_moi > dp[j]) {
              const oldVal = dp[j];
              dp[j] = gia_tri_moi;
              steps.push({
                dp: [...dp],
                i,
                j,
                L: 5,
                msg: `Vì ${gia_tri_moi} lớn hơn giá trị cũ (${oldVal}), ta cập nhật dp[${j}] = ${gia_tri_moi}.`,
              });
            } else {
              steps.push({
                dp: [...dp],
                i,
                j,
                L: 4,
                msg: `Vì ${gia_tri_moi} không tốt hơn ${dp[j]}, ta giữ nguyên giá trị tối ưu hiện tại.`,
              });
            }
          }
        }
        steps.push({
          dp: [...dp],
          i: -1,
          j: -1,
          L: 8,
          isFinal: true,
          msg: `Thuật toán kết thúc! Giá trị lớn nhất có thể đạt được là ${dp[m]}.`,
        });
      }

      function render() {
        const step = steps[currentStep];
        const m = parseInt(document.getElementById("inputM").value);
        const grid = document.getElementById("dpGrid");
        grid.innerHTML = "";

        step.dp.forEach((val, idx) => {
          let statusClass = "bg-slate-900/50 border-white/5 text-slate-300";
          let extra = "";

          if (idx === step.j) {
            statusClass = "cell-target animate-pulse-slow";
            extra =
              '<div class="absolute -top-3 -right-3 w-8 h-8 md:w-10 md:h-10 bg-yellow-400 rounded-2xl flex items-center justify-center text-slate-900 shadow-xl shadow-yellow-400/20 rotate-12"><i class="fas fa-shopping-bag text-xs md:text-sm"></i></div>';
          } else if (step.j !== -1 && idx === step.j - items[step.i].w) {
            statusClass = "cell-source";
            extra =
              '<div class="absolute -top-2 -left-2 bg-blue-400 text-white p-1 rounded-md text-[8px] font-bold">SOURCE</div>';
          }

          grid.innerHTML += `
            <div class="dp-cell ${statusClass}">
                <span class="text-[8px] md:text-[10px] font-bold opacity-40 absolute top-2">j=${idx}</span>
                <span class="text-base md:text-xl font-bold mt-2">${val}</span>
                ${extra}
            </div>`;
        });

        // Highlight current item card
        document.querySelectorAll('[id^="item-card-"]').forEach((el, idx) => {
          el.className = el.className
            .replace(/item-active|opacity-40/g, "")
            .trim();

          if (step.i === -1) {
            // Neutral state
          } else if (idx === step.i) {
            el.classList.add("item-active");
          } else {
            el.classList.add("opacity-40");
          }
        });

        // Code highlighting
        document
          .querySelectorAll(".code-line")
          .forEach((el) => el.classList.remove("active"));
        if (step.L > 0) {
          const codeEl = document.getElementById(`L${step.L}`);
          if (codeEl) codeEl.classList.add("active");
        }

        document.getElementById("loopCode").innerText =
          document.getElementById("algoType").value === "01"
            ? "M; j >= w[i]; j--"
            : "w[i]; j <= M; j++";

        // Text animation for explanation
        const explainEl = document.getElementById("explanation");
        explainEl.style.opacity = 0;
        explainEl.style.transform = "translateY(5px)";
        setTimeout(() => {
          explainEl.innerText = step.msg;
          explainEl.style.opacity = 1;
          explainEl.style.transform = "translateY(0)";
          explainEl.style.transition = "all 0.3s ease-out";
        }, 50);

        if (step.isFinal) {
          confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            colors: ["#8b5cf6", "#c4b5fd", "#ffffff"],
          });
        }

        // Update buttons
        document.getElementById("btnPrev").disabled = currentStep <= 0;
        document.getElementById("btnNext").disabled =
          currentStep >= steps.length - 1;

        // Sync mobile buttons
        const playBtns = [
          document.getElementById("btnPlay"),
          document.getElementById("mobilePlay"),
        ];
        playBtns.forEach((btn) => {
          if (isAuto) btn.classList.add("paused");
          else btn.classList.remove("paused");
        });
      }

      function toggleAuto() {
        isAuto = !isAuto;
        const playBtn = document.getElementById("btnPlay");
        const mobilePlay = document.getElementById("mobilePlay");

        [playBtn, mobilePlay].forEach((btn) => {
          if (isAuto) {
            btn.innerHTML =
              '<i class="fas fa-pause"></i> <span>Tạm dừng</span>';
            btn.classList.add("paused");
          } else {
            btn.innerHTML = '<i class="fas fa-play"></i> <span>Tự động</span>';
            btn.classList.remove("paused");
          }
        });

        if (isAuto) autoRun();
        else clearTimeout(timer);
      }

      function autoRun() {
        if (!isAuto) return;
        if (currentStep < steps.length - 1) {
          nextStep();
          const delay = 2000 - parseInt(document.getElementById("speed").value);
          timer = setTimeout(autoRun, delay);
        } else {
          toggleAuto();
        }
      }

      function nextStep() {
        if (currentStep < steps.length - 1) {
          currentStep++;
          render();
        }
      }
      function prevStep() {
        if (currentStep > 0) {
          currentStep--;
          render();
        }
      }
      function resetSim() {
        clearTimeout(timer);
        isAuto = false;

        const playBtn = document.getElementById("btnPlay");
        const mobilePlay = document.getElementById("mobilePlay");
        [playBtn, mobilePlay].forEach((btn) => {
          btn.innerHTML = '<i class="fas fa-play"></i> <span>Tự động</span>';
          btn.classList.remove("paused");
        });

        generateSteps();
        currentStep = 0;
        render();
      }

      // Initial Call
      updateItemsUI();
    </script>
  </body>
</html>
